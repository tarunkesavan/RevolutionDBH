version: 0.2

phases:
  install:
    commands:
      - echo "Installing dependencies"
      - apt-get update
      - apt-get install -y build-essential cmake python3-dev
      - apt-get install -y libpcl-dev libarmadillo-dev libxlsxwriter-dev
  pre_build:
    commands:
      - echo "Starting build..."
      - chmod +x ./treeseg/scripts/build.sh
      - echo "Updating C++ standard to C++17..."
      - sed -i 's/set(CMAKE_CXX_STANDARD 11)/set(CMAKE_CXX_STANDARD 17)/g' treeseg/CMakeLists.txt
      - echo "Updating Python paths in CMakeLists.txt..."
      - |
        PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
        PYTHON_INCLUDE=$(python3 -c "import sysconfig; print(sysconfig.get_path('include'))")
        PYTHON_LIB=$(python3 -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR'))")
        PYTHON_LIBNAME=$(python3 -c "import sysconfig; print(f\"libpython{sysconfig.get_config_var('LDVERSION')}.so\")")
        sed -i "s|set(Python3_ROOT_DIR \"/Library/Frameworks/Python.framework/Versions/3.11\")|set(Python3_ROOT_DIR \"/usr\")|g" treeseg/CMakeLists.txt
        sed -i "s|/Library/Frameworks/Python.framework/Versions/3.11/include/python3.11|$PYTHON_INCLUDE|g" treeseg/CMakeLists.txt
        sed -i "s|/Library/Frameworks/Python.framework/Versions/3.11/lib/libpython3.11.dylib|$PYTHON_LIB/$PYTHON_LIBNAME|g" treeseg/CMakeLists.txt
  build:
    commands:
      - echo "Running build script"
      - cd treeseg
      - mkdir -p build
      - cd build
      - cmake ..
      - make -j$(nproc)
      - cd $CODEBUILD_SRC_DIR
  post_build:
    commands:
      - echo "Organizing build artifacts..."
      - mkdir -p treeseg/deploy/bin
      - mkdir -p treeseg/deploy/lib
      - echo "Copying executables..."
      - cp treeseg/build/findstems treeseg/deploy/bin/ || echo "findstems not found"
      - cp treeseg/build/downsample treeseg/deploy/bin/ || echo "downsample not found"
      - cp treeseg/build/getdtmslice treeseg/deploy/bin/ || echo "getdtmslice not found"
      - cp treeseg/build/nearestneighbour treeseg/deploy/bin/ || echo "nearestneighbour not found"
      - cp treeseg/build/plotcoords treeseg/deploy/bin/ || echo "plotcoords not found"
      - cp treeseg/build/segmentstem treeseg/deploy/bin/ || echo "segmentstem not found"
      - cp treeseg/build/getcrownvolume treeseg/deploy/bin/ || echo "getcrownvolume not found"
      - cp treeseg/build/segmentcrown treeseg/deploy/bin/ || echo "segmentcrown not found"
      - cp treeseg/build/sepwoodleaf treeseg/deploy/bin/ || echo "sepwoodleaf not found"
      - cp treeseg/build/pcdPointTreeseg2txt treeseg/deploy/bin/ || echo "pcdPointTreeseg2txt not found"
      - cp treeseg/build/txtPointTreeseg2pcd treeseg/deploy/bin/ || echo "txtPointTreeseg2pcd not found"
      - cp treeseg/build/pcdPointXYZRGB2txt treeseg/deploy/bin/ || echo "pcdPointXYZRGB2txt not found"
      - cp treeseg/build/thin treeseg/deploy/bin/ || echo "thin not found"
      - echo "Copying shared libraries..."
      - cp treeseg/build/*.so treeseg/deploy/lib/ || echo "No .so files found"
      - echo "Build artifacts ready:"
      - ls -la treeseg/deploy/bin/
      - ls -la treeseg/deploy/lib/

artifacts:
  files:
    - appspec.yml
    - treeseg/deploy/**/*
    - treeseg/scripts/**/*